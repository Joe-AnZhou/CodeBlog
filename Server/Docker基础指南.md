# Docker Notes(记录中)

[toc]

> Docker中一些重要的基础性概念，非常欢迎大家一起补充。

## 基础

### Docker是什么

概念： **`Docker`属于Linux容器的一种封装，提供简单易用的容器使用接口**。

`Docker`将应用程序与该程序的依赖，打包在一个文件中。运行这个文件，就会生成一个虚拟容器。程序在这个虚拟容器中运行，就好像在真实的物理机上运行一样。

### Docker的用途

1. **提供一次性的环境**： 例如：本地测试他人的软件，持续集成的时候提供单元测试和构建的环境。
2. **提供弹性的云服务**：由于`Docker`容器可以随时开关，非常时候动态扩容和缩容。
3. **组建微服务架构**：通过多个容器，一台机器可以跑多个服务，因此在本机就可以模拟出微服务架构。

### 容器(Container)和镜像(Image)

**镜像**：Docker镜像可以理解为包含应用程序及其相关依赖的一个基础文件系统，在Docker容器的启动过程中，它以只读的方式用于**创建容器的运行环境。**

**容器**： 容器的实质就是一个**进程**， 但是容器进程运行于属于自己的独立命名空间中。因此容器可以拥有自己的 `root` 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。

所以镜像指的是包含运行环境的只读文件系统，而容器可以说是在镜像环境下运行的程序。

**关系**： 镜像和容器的关系，就像是面向对象程序设计中的类和实例的关系。镜像是静态的类，而容器是镜像运行时的实体。

### 容器基本操作

首先我们需要了解容器存在的状态：

- **Created**： 已经创建完毕，相关资源已经准备就绪，但是容器中的程序还处于未运行的状态。
- **Running**： 容器（容器中的应用）正在运行。
- **Paused**： 容器中的所有程序处于**暂停**的状态。
- **Stopped**： 容器中的程序处理停止状态。
- **Created**：容器已经删除，相关占用的资源及存储，在Docker中的管理信息都已经被释放和删除。

操作命令

<small>备注： 下面命令中的`name`指的是容器名称， `image`指的是镜像名称。</small>

- 创建： `docker create --name name image`
- 启动： `docker start name`
- 创建+启动： `docker run --name name --detach image `   --detach: 启动后将程序和控制台分离，使之进入后台模式。
- 查看：`docker ps --all` 
- 停止：`docker stop name` (沙盒系统还存在，修改的内容也都保存)
- 删除： `docker rm name --force`
- 进入容器： `docker exec -it name bash`   其中 `-i` ( `--interactive` ) 表示保持我们的输入流。 `-t` ( `--tty` ) 表示启用一个伪终端，形成我们与 bash 的交互 。
- 衔接容器： `docker attach name` 这个命令最直观的效果可以理解为我们将容器中的主程序转为了“前台”运行 ( 与 `docker run` 中的 `-d` 选项有相反的意思 )。

以启动一个`nginx`容器服务作为示例
``` shell
docker run -d -rm -p 8800:80 -v /home/nginx/html:/usr/share/nginx/html --name nginx nginx

-d: 在后台云运行
-p 映射端口号
-rm 容器停止后自动自动删除容器文件
--name 容器名称
--volume/-v /home/nginx/html :/usr/share/nginx/html
```

### 容器网络

> 容器网络实质上也是由 Docker 为应用程序所创造的虚拟环境的一部分，它能让应用从宿主机操作系统的网络环境中独立出来，形成容器自有的**网络设备、IP 协议栈、端口套接字、IP 路由表、防火墙等等与网络相关的模块**。

核心概念

- **沙盒 ( Sandbox )**: 提供容器网络栈，主要是隔离了容器网络和宿主机网络，形成完全独立的容器网络环境。
- **网络 ( Network )**: `Docker`内部的虚拟子网，与宿主机网络存在隔离关系，主要目的是形成容器间的安全通讯环境。
- **端点 ( Endpoint )**: 主要目的是形成一个可以控制的突破封闭网络环境的出入口。当容器的端点与网络的断点匹配之后，就如同在两者之间搭建了桥梁，就能进行数据传输了。
  
### 数据管理

**数据卷**: 是一个可供一个或者多个容器使用的特殊目录, 可以在多个容器之前共享和重用,修改之后马上更新,且数据卷的更新不会影响镜像,数据卷会一直存在,即使容器被删除.

### 数据管理

数据是应用程序的重要产出，数据可以说是最重要的资产。但是在`docker`中容器运行的文件系统处在于沙盒之中，与外界是隔离的，所以必须是有合理的方式与外界进行数据交换。

**数据卷**

数据卷是一个可供一个或者多个容器使用的特殊目录，它绕过UFS，可以提供很多有用的特征。数据卷可以在容器之中共享和重用，对数据卷的修改立马生效，对数据卷的更新，不会影响镜像，数据卷是持久的，即使容器被删除。

**挂载方式**

- **Bind Mount**： 直接把宿主操作系统中的目录和文件挂载到容器中的文件系统中，通过指定容器外的路径和容器内的路径，就形成了挂载映射关系，在容器内外对文件的读写都是相互可见的。
- **Volume**：从宿主操作系统中挂载目录到容器内，只不过目录是由`Docker`进行管理，我们只需指定容器内的目录，不需要关心具体挂载到宿主操作系统中的哪里。
- **Tmpfs Mount**：支持挂载系统内存中的一部分到容器的文件系统里，不过由于内存和容器的特征。这个存储并不会持久，其中的内容会随着容器的停止而消失。一般用于挂载临时文件目录。

下面是`nginx`挂载目录的示例：

```bash
# 示例命令
docker container run 
-d 
-p 8800:80 
--rm 
--name nginx
-v /home/nginx/html:/usr/share/nginx/html 
nginx

# 命令解读
-d：在后台运行
-p ：容器的80端口映射到127.0.0.2:8080
--rm：容器停止运行后，自动删除容器文件
--name：容器的名字为nginx
-v：--volume 的缩写形式
```


### `Dockerfile`

这是`docker`特有的镜像构建定义文件，通过了解它就能真正体验一种秒级镜像构建的乐趣。

`Dockerfile`是`Docker`中用于定义镜像自动化构建的流程的配置文件，文件中包含了构建镜像过程中需要执行的命令和其他的操作。

**优点**

- 体积远小于镜像包，更容易进行快速迁移和部署。
- 环境构建流程在文件中展示，能够直观的看见镜像构建的顺序和逻辑。
- 能够更轻松的实现自动部署等自动化流程。
- 修改环境仅仅修改文件，要比从新提交镜像要简单的多。

## 基础进阶

## 总结

